var EdoceoCommunityFormMessageManager={};EdoceoCommunityFormMessageManager.instances=[];EdoceoCommunityFormMessageManager.init=function init(form_id,post_url,get_base_url,ajax_mode,hide_attachments_on_blur){if(!EdoceoCommunityFormMessageManager.instances[form_id]){EdoceoCommunityFormMessageManager.instances[form_id]={'id':form_id,'post_url':post_url,'get_base_url':get_base_url,'send_trigger':'#'+form_id+' .submit-trigger','ajax_mode':ajax_mode};if(ajax_mode){$(EdoceoCommunityFormMessageManager.instances[form_id].send_trigger).on('click',function(e){e.preventDefault();EdoceoCommunityFormMessageManager.sendMessage(form_id);});}
var $attachments=$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id+' .attachments-collection');if($attachments.length>0){$attachments.collection({allow_up:false,allow_down:false,add_at_the_end:true,remove:'<a href="#">&#10006;</a>',after_remove:EdoceoCommunityFormMessageManager.updateAttachmentDisplay.bind(null,form_id)});EdoceoCommunityFormMessageManager.updateAttachmentDisplay(form_id);}
$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id+' .posting-attachment a.attachment-item').click(function(e){e.preventDefault();});$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id+' .posting-attachment a.attachment-item').mousedown(function(e){e.preventDefault();EdoceoCommunityFormMessageManager.addAttachment(form_id,$(this));});var initialization=true;$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id+' select[name*="[diffusion_choice]"]').change(function(e){var $form=$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id);if(!initialization){$form.find('.user-collection select, .group-collection select').select2('val','');$form.find('.user-entry, .group-entry').each(function(){$(this).find('.collection-remove').click();});initialization=false;}
if($(this).val()=='context'){$form.find('.user-collection').hide();$form.find('.group-collection').hide();}else if($(this).val()=='users'){$form.find('.user-collection').show();$form.find('.group-collection').hide();}else{$form.find('.user-collection').hide();$form.find('.group-collection').show();}
var $popup_opener=$form.find('[id$="popup_opener"]');if(initialization){EdoceoCommunityFormMessageManager.updateDiffusionChoice(form_id);$form.find('.modal-popup').on('modal-closing',EdoceoCommunityFormMessageManager.closingDiffusionModal.bind(null,form_id));}else{$popup_opener.html($popup_opener.next('.btn-dropdown-container.actions').find('[data-context*="'+$(this).val()+'"]').text()+'<span class="dropdown"></span>');}}).change();$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id+' .attachments-collection .attachment-entry').each(function(){EdoceoCommunityFormMessageManager.displayAttachment($(this),null,null);});$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id+'_popup_opener').on('show-dropdown',EdoceoCommunityFormMessageManager.showDiffusionModal.bind(null,form_id));$('#'+form_id+' .user-collection, '+'#'+form_id+' .group-collection').on('new-item',EdoceoCommunityFormMessageManager.updateDiffusionChoice.bind(null,form_id));$('#'+form_id+' .user-collection, '+'#'+form_id+' .group-collection').on('deleted-item',EdoceoCommunityFormMessageManager.updateDiffusionChoice.bind(null,form_id));$('#'+form_id+' .tags-collection').on('deleted-item maximum-items-reached',EdoceoCommunityFormMessageManager.updateTags.bind(null,form_id));$('#'+form_id).on('advanced-text-editor-show',function(e){if(hide_attachments_on_blur&&$(this).find('.attachments-collection .attachment-entry').length<5){$(this).find('.posting-attachment').show();}});$('#'+form_id).on('advanced-text-editor-hide',function(e){if(hide_attachments_on_blur&&e.isEmpty){$(this).find('.posting-attachment').hide();}});}};EdoceoCommunityFormMessageManager.updateTags=function(form_id,event){var $form=$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id);if(event.type=="maximum-items-reached"){$form.find('.maximum-tags').show();}else if(event.type=="deleted-item"){$form.find('.maximum-tags').hide();}};EdoceoCommunityFormMessageManager.updateAttachmentDisplay=function(form_id){var $form=$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id);if($form.find('.attachments-collection .attachment-entry').length>=5){$form.find('.posting-attachment').hide();}else{$form.find('.maximum-attachments').hide();}};EdoceoCommunityFormMessageManager.updateDiffusionChoice=function(form_id){var $form=$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id);var context=$form.find('select[name*="[diffusion_choice]"]').val();var $popup_opener=$form.find('[id$="popup_opener"]');var count_items=0;if(context=='users'){count_items=$form.find('.user-entry.form-row').length;}else if(context=='groups'){count_items=$form.find('.group-entry.form-row').length;}
if(count_items==1){context=context.substr(0,context.length-1);}
$popup_opener.html((count_items>0?count_items+' ':'')+$popup_opener.next('.btn-dropdown-container.actions').find('[data-context="'+context+'"]').text()+'<span class="dropdown"></span>');};EdoceoCommunityFormMessageManager.showDiffusionModal=function(form_id,event){event.preventDefault();event.stopPropagation();if(!$(event.target).hasClass('disabled')){var $form=$('#'+form_id);var $modal=$form.find('.modal-popup');$form.find('span.error').remove();FTModalPopup.open($modal.attr('id'));}};EdoceoCommunityFormMessageManager.closingDiffusionModal=function(form_id,event){if(event.action=="valid"){var $form=$('#'+EdoceoCommunityFormMessageManager.instances[form_id].id);var context=$form.find('select[name*="[diffusion_choice]"]').val();var count_items=-1;if(context=='users'){count_items=$form.find('.user-entry.form-row').length;}else if(context=='groups'){count_items=$form.find('.group-entry.form-row').length;}
if(count_items==0){if(context=='users'){if($form.find('span.error').length==0){$form.find('.user-collection.form-row > div label').append('<span class="error" style="color: red"> *</span>');}}else{if($form.find('span.error').length==0){$form.find('.group-collection.form-row > div label').append('<span class="error" style="color: red"> *</span>');}}
event.preventDefault();}}};EdoceoCommunityFormMessageManager.setGetExtraParams=function(form_id,extra_params){EdoceoCommunityFormMessageManager.instances[form_id].get_extra_params=extra_params;};EdoceoCommunityFormMessageManager.resetForm=function(form_id){var instance=EdoceoCommunityFormMessageManager.instances[form_id];var $form=$('#'+instance.id);var $attachments=$('#'+instance.id+' .attachments-collection .attachment-entry');$attachments.each(function(){$(this).find('.collection-remove').click();});if($form.find('.tags-collection select').length>0){$form.find('.tags-collection select').select2('val','');$form.find('.user-entry, .group-entry').each(function(){$(this).find('.collection-remove').click();});}
if($form.find('.user-collection select').length>0){$form.find('select[name*="[diffusion_choice]"]').val('context').change();}
FTAdvancedTextEditor.reset($form.find('.advanced-text-editor').attr('id'));EdoceoCommunityFormMessageManager.updateAttachmentDisplay(form_id);};EdoceoCommunityFormMessageManager.addAttachment=function(form_id,$trigger){var instance=EdoceoCommunityFormMessageManager.instances[form_id];var type=$trigger.data('type');var image=$trigger.find('img');var $form=$('#'+instance.id);if($form.find('.attachments-collection .attachment-entry').length>=5){return false;}
if(image.length==0&&$trigger.find('span').length>0){var tmp_image=$trigger.find('span').css('background-image').replace(/url\(([^\)]+)\)/i,'$1').replace(/"|'/gi,'').replace(/images\/(.+)\.png/i,'images/$1_snd_color.png');if(tmp_image){image=$('<img />').attr('src',tmp_image);}}
$('#'+instance.id+' .attachments-collection .collection-action.collection-rescue-add').click();var $new_element=$('#'+instance.id+' .attachments-collection .attachment-entry').last();$new_element.find('input[type="hidden"][name*="type"]').val(type);var accept=$trigger.data('accept')?$trigger.data('accept'):null;EdoceoCommunityFormMessageManager.displayAttachment($new_element,image,accept);if(!FTUtils.isScrolledIntoView($new_element)){$('html, body').animate({scrollTop:$(window).scrollTop()+$new_element.height()},350);}
EdoceoCommunityFormMessageManager.updateAttachmentDisplay(form_id);};EdoceoCommunityFormMessageManager.displayAttachment=function($element,image,accept){var type=$element.find('input[type="hidden"][name*="type"]').val();if(!image){var tmp_image=$('.posting-attachment .btn-dropdown-container.actions').find('[data-type="'+type+'"] span').css('background-image').replace(/url\(([^\)]+)\)/i,'$1').replace(/"|'/gi,'').replace(/images\/(.+)\.png/i,'images/$1_snd_color.png');if(tmp_image){image=$('<img />').attr('src',tmp_image);}}
if(image&&image.length>0){$element.find('.attachment-icon').append(image.clone());}
if(type=='link'){$element.find('input[type="file"]').hide();}else if(type=='document'){var $filename=$element.find('input[name*="[filename]"]');var $dropzone=$element.find('.attachment-dropzone');var $link=$element.find('input[type="text"][name*="link"]');if($filename.val()!=''){var extension=$link.val().substr($link.val().lastIndexOf('.')+1);$dropzone.find('span').text($dropzone.find('span').text()+' ('+$filename.val()+'.'+extension+')');}
var $file_input=$element.find('input[type="file"]');$link.hide();if(accept){$file_input.prop('accept',accept);}
$dropzone.css({'height':$file_input.outerHeight()+'px','width':$file_input.outerWidth()+'px','top':0}).show();$file_input.css({'opacity':0});$file_input.fileupload();$file_input.fileupload('option',{dropZone:$element.find('.attachment-dropzone'),url:BASEDIR+'/scripts/ajax/attachments_upload.php',autoUpload:false,dataType:'json',progressall:function(e,data){var $container=$element.find('.attachment-input');if($container.find('.progress-bar').length==0){$container.css('position','relative');$container.append('<div class="progress-bar"></div>');}
var $file_input=$element.find('input[type="file"]');var $progress_bar=$container.find('.progress-bar');var progress=parseInt(data.loaded/data.total*100,10);$progress_bar.css({'height':'5px','position':'absolute','background-color':'green','left':0});$progress_bar.css({'width':$file_input.width()*progress/100});},add:function(e,data){$element.find('input[type="file"]').css({'border-color':'#d1d3d5'});var jqXHR=data.submit().error(function(){$element.find('.progress-bar').remove();$element.find('.attachment-dropzone').css({'border-color':'#a94442'});});},done:function(e,data){var response=data._response.result;$element.find('.progress-bar').remove();$element.find('.attachment-dropzone').hide();if(response.status=='OK'){$element.find('input[type="hidden"][name*="filename"]').val(response.result.filename);$element.find('input[type="text"][name*="link"]').val(response.result.filename+'.'+response.result.extension);$element.find('input[type="hidden"][name*="tmp_filename"]').val(response.result.file);$element.find('input[type="file"]').hide();$element.find('input[type="text"][name*="link"]').prop('readonly',true);$element.find('input[type="text"][name*="link"]').show();}}});}};EdoceoCommunityFormMessageManager.setReadOnly=function(form_id){var instance=EdoceoCommunityFormMessageManager.instances[form_id];var $form=$('#'+instance.id);FTAdvancedTextEditor.disable($form.find('.advanced-text-editor').attr('id'));$form.find('.btn-diffusion').addClass('disabled');$form.find('input,button').each(function(){$(this).prop('disabled',true);});};EdoceoCommunityFormMessageManager.removeReadOnly=function(form_id){var instance=EdoceoCommunityFormMessageManager.instances[form_id];var $form=$('#'+instance.id);FTAdvancedTextEditor.enable($form.find('.advanced-text-editor').attr('id'));$form.find('.btn-diffusion').removeClass('disabled');$form.find('input,button').each(function(){$(this).prop('disabled',false);});};EdoceoCommunityFormMessageManager.appendNewMessage=function(form_id,message_id){var instance=EdoceoCommunityFormMessageManager.instances[form_id];var form=$('#'+instance.id);var $modal=form.find('.modal-popup');$.ajax({type:'GET',url:instance.get_base_url+message_id+'.html?'+$.param(instance.get_extra_params),success:function(data){EdoceoCommunityFormMessageManager.removeReadOnly(form_id);EdoceoCommunityFormMessageManager.resetForm(form_id);if($modal.length>0){FTModalPopup.close($modal.attr('id'));}
$('#'+instance.id).trigger('new_message',[data,message_id]);}});};EdoceoCommunityFormMessageManager.removeEmptyAttachments=function(form_id){var instance=EdoceoCommunityFormMessageManager.instances[form_id];var $attachments=$('#'+instance.id+' .attachments-collection .attachment-entry');$attachments.each(function(){if($(this).find('input[type="text"][name*="link"]').val()==''){$(this).find('.collection-remove').click();}});EdoceoCommunityFormMessageManager.updateAttachmentDisplay(form_id);};EdoceoCommunityFormMessageManager.sendMessage=function(form_id){var instance=EdoceoCommunityFormMessageManager.instances[form_id];var form=$('#'+instance.id);var advanced_text_editor_id=form.find('.advanced-text-editor').attr('id');EdoceoCommunityFormMessageManager.removeEmptyAttachments(form_id);if(FTAdvancedTextEditor.getContent(advanced_text_editor_id)==''){FTAdvancedTextEditor.focus(advanced_text_editor_id);return false;}
var context=form.find('select[name*="[diffusion_choice]"]').val();var count_items=-1;if(context=='users'){count_items=form.find('.user-entry.form-row').length;}else if(context=='groups'){count_items=form.find('.group-entry.form-row').length;}
if(count_items==0){var $modal=form.find('.modal-popup');FTModalPopup.open($modal.attr('id'));return false;}
var form_serialized=form.find('[name^="'+instance.id+'"]').serialize();EdoceoCommunityFormMessageManager.setReadOnly(form_id);$.ajax({type:'POST',url:instance.post_url,data:form_serialized,error:function(jqXHR,textStatus,errorThrown){EdoceoCommunityFormMessageManager.removeReadOnly(form_id);alert('An error occured during post message');},success:function(data,textStatus,jqXHR){var event=jQuery.Event("new_user_response",[data]);$('#'+instance.id).trigger(event,[data]);if(event.isDefaultPrevented()){return;}
EdoceoCommunityFormMessageManager.appendNewMessage(form_id,data.id);},dataType:'JSON'});};
$(function(){var interval=setInterval(function(){$('.embedly-preloader').each(function(){if(FTUtils.isScrolledIntoView($(this))&&!$(this).hasClass('loading')){$(this).addClass('loading');$(this).parent().css({'height':$(this).height()+'px'});$(this).css({'position':'absolute'});var clone=$(this).next('a').clone();clone.addClass('embedly-card');clone.appendTo($(this).parent());}});},1000);if(typeof embedly!='undefined'){embedly('on','card.rendered',function(iframe){$card=$(iframe);$card.parents('.post-attachment').find('.embedly-preloader').remove();});}});